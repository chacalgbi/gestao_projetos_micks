<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <link rel="shortcut icon" type="image/x-icon" href="./assets/img/icon.png">
    <title>Itens</title>
    <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="./assets/dist/js/jquery-3.6.0.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="./assets/dist/js/sweetalert2.all.min.js"></script>
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script src="./assets/dist/js/pace.js"></script>
    <link rel="stylesheet" href="./assets/dist/css/red/radar.css">
    <script src="./assets/dist/js/notify.js"></script>
    <style>
      body {
        background: url(./assets/img/concreto.jpg) no-repeat center top fixed;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
      }
      #corpo{
        background-color: #1C1C1C;
      }
      #principal{
        background-color: #242323;
        opacity : 0.7;
      }
      .infor{
        background-color: #4b4a4a;
        border-radius: 20px;
        margin-left: 8px;
        margin-top: 3px;
        padding: 0.4rem;
      }
      .modais{
        background: url(./assets/img/concreto.jpg) no-repeat center top fixed;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
      }
      .modal-title{
        color: black;
      }
      .modal-body{
        color: aliceblue;
      }
    </style>
  </head>
  <body>
    <div id="header"></div><br /><br /><br />
    <div id="principal" class="container p-3 mb-2 text-white border border-secondary" style="border-radius: 30px;">
      <div class="row d-flex justify-content-evenly">
        <div class="info col-sm-11 d-flex justify-content-evenly">
          <h1>Itens</h1>
        </div>
      </div>
      <button type="button" onclick="abrir_cadastro_item()" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modal_inserir">Cadastrar Itens</button>
      <div class="row info justify-content-center" id="info">
        <table class="table table-dark table-hover">
          <thead>
             <tr>
               <th>#</th>
               <th>Item</th>
               <th>Projeto</th>
               <th>Qtd</th>
               <th>Pre. Uni</th>
               <th>Pre. Total</th>
               <th>Pagamento</th>
               <th>Categoria</th>
               <th>OBS</th>
               <th>Editar</th>
             </tr>
          </thead>
          <tbody id="corpo_tabela">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Editar -->
    <div class="modal fade" id="modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content modais">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Editar Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div>ID:<label id="id_"></label></div>
              <div class="input-group mb-3"><span class="input-group-text">Nome:</span><input type="text" class="form-control" id="nome"></div>
              <div class="input-group mb-3"><span class="input-group-text">Programa:</span><select class="form-control" id="programa"></select></div>
              <div class="input-group mb-3"><span class="input-group-text">Envolvidos:</span><div id="checks"></div></div>
              <div class="input-group mb-3"><span class="input-group-text">Objetivos:</span><textarea class="form-control" rows="3" id="objetivos"></textarea></div>
              <div class="input-group mb-3"><span class="input-group-text">OBS:</span><textarea class="form-control" rows="3" id="obs"></textarea></div>
              <div class="input-group mb-3"><span class="input-group-text">Prev. Início:</span><input type="date" class="form-control" id="prev_inicio"></div>
              <div class="input-group mb-3"><span class="input-group-text">Prev. Fim:</span><input type="date" class="form-control" id="prev_fim"></div>
              <div class="input-group mb-3"><span class="input-group-text">Concluído?</span><select class="form-control" id="concluido"></select></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="btn_editar" onclick="editar_projeto()">Alterar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Inserir -->
    <div class="modal fade" id="modal_inserir" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Cadastrar Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="input-group mb-3"><span class="input-group-text">Item:          </span><input type="text"   class="form-control" id="nome_insert"></div>
              <div class="input-group mb-3"><span class="input-group-text">Quantidade:    </span><input type="number" class="form-control" id="qtd_insert" value="0"></div>
              <div class="input-group mb-3"><span class="input-group-text">Preço Unit R$: </span><input type="text"   class="form-control" id="uni_insert" value="0" onblur="calcular_total_parcial()"></div>
              <div class="input-group mb-3"><span class="input-group-text">Preço Total R$:</span><input type="text"   class="form-control" id="total_insert"></div>
              <div class="input-group mb-3"><span class="input-group-text">Projeto:       </span><select class="form-control" id="projeto_insert"></select></div>
              <div class="input-group mb-3"><span class="input-group-text">Pagamento:     </span><select class="form-control" id="pagamento_insert"></select></div>
              <div class="input-group mb-3"><span class="input-group-text">Categoria:     </span><select class="form-control" id="categoria_insert"></select></div>
              <div class="input-group mb-3"><span class="input-group-text">OBS:           </span><textarea class="form-control" rows="3" id="obs_insert"></textarea></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="btn_inserir" onclick="btn_cadastrar()">Cadastrar</button>
          </div>
        </div>
      </div>
    </div>
    <script src="./assets/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/dist/js/geral.js"></script>
    <script src="./assets/dist/js/jquery-mask.js"></script>

    <script>
      var ip = sessionStorage.ip;
      var array_pagamentos = [];
      var array_categorias = [];
      var array_projetos = [];
      var array_itens = [];
      $("#header").load("menu/menu.html");
      $(document).ready( function ($){
        $('#uni_insert').mask('000.000.000.000.000,00', {reverse: true});
        verificar();
      });

      function preencher_tabela(){
        let tabela = "";
        array_itens.map((item, index, array)=>{

          let nome_categoria = "";
          array_categorias.forEach((x)=>{ if(item.categoria == x.id){ nome_categoria = x.categoria }});

          let nome_pagamentos = "";
          array_pagamentos.forEach((x)=>{ if(item.forma_pagamento == x.id){ nome_pagamentos = x.forma }});

          let nome_projetos = "";
          array_projetos.forEach((x)=>{ if(item.id_projeto == x.id){ nome_projetos = x.nome }});

          tabela += "<tr>";
            tabela += `
            <td>${index+1}</td>
            <td>${item.nome}</td>
            <td>${nome_projetos}</td>
            <td>${item.qtd}</td>
            <td>${item.uni}</td>
            <td>${item.total}</td>
            <td>${nome_pagamentos}</td>
            <td>${nome_categoria}</td>
            <td>${item.obs}</td>
            <td><button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modal"
              data-bs-id="${item.id}"
              data-bs-nome="${item.nome}"
              data-bs-prog="${item.id_projeto}"
              data-bs-responsaveis="${item.qtd}"
              data-bs-objetivo="${item.preco_uni}"
              data-bs-inicio="${item.preco_total}"
              data-bs-fim="${item.forma_pagamento}"
              data-bs-concluido="${item.categoria}"
              data-bs-obs="${item.obs}"
            >Editar</button></td>
            `;
          tabela += "</tr>";
        });
        document.getElementById('corpo_tabela').innerHTML = tabela;
      }

      function abrir_cadastro_item(){
        // Colocar os options com os projetos para serem selecionados
        let select_projetos = "<option selected disabled>Selecione um projeto</option>";
        array_projetos.map((item)=>{
          select_projetos += `<option value="${item.id}">${item.nome}</option>`;
        });
        document.getElementById('projeto_insert').innerHTML = select_projetos;

        // Colocar os options com os tipos de pagamento para serem selecionados
        let select_pags = "<option selected disabled>Selecione uma forma de pagamento</option>";
        array_pagamentos.map((item)=>{
          select_pags += `<option value="${item.id}">${item.forma}</option>`;
        });
        document.getElementById('pagamento_insert').innerHTML = select_pags;

        // Colocar os options com as categorias para serem selecionados
        let select_categorias = "<option selected disabled>Selecione uma categoria</option>";
        array_categorias.map((item)=>{
          select_categorias += `<option value="${item.id}">${item.categoria}</option>`;
        });
        document.getElementById('categoria_insert').innerHTML = select_categorias;

      }

      function calcular_total_parcial(){
        let qtd  = parseFloat(document.getElementById('qtd_insert').value);
        let unit = parseFloat(document.getElementById('uni_insert').value.replace(".","").replace(",","."));
        let total = (qtd * unit).toFixed(2);
        document.getElementById('total_insert').value = total;
        document.getElementById('projeto_insert').focus()
      }

      function salvar_item(){
        let obj_item = {
          id_projeto:
          nome:
          qtd:
          preco_uni:
          preco_total:
          forma_pagamento:
          categoria:
          obs:
        }
      }

      async function iniciar(){
        if(sessionStorage.login === "OK"){
          array_pagamentos = await listar_pagamentos();
          array_categorias = await listar_categorias();
          array_itens      = await listar_itens();
          array_projetos   = await listar_projetos();
          preencher_tabela();
        }
      }

      iniciar();

      // Modal de Cadastro de itens.
      var insert_modal = document.getElementById('modal_inserir');
      insert_modal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        setTimeout(function() { document.getElementById('nome_insert').focus() },500);
      });

    </script>
  </body>
</html>
