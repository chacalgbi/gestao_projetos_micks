<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <link rel="shortcut icon" type="image/x-icon" href="./assets/img/icon.png">
    <title>Gastos</title>
    <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="./assets/dist/js/jquery-3.6.0.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="./assets/dist/js/sweetalert2.all.min.js"></script>
    <script src="https://unpkg.com/boxicons@2.1.0/dist/boxicons.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.0/css/boxicons.min.css' rel='stylesheet'>
    <script src="./assets/dist/js/pace.js"></script>
    <link rel="stylesheet" href="./assets/dist/css/red/radar.css">
    <script src="./assets/dist/js/notify.js"></script>
    <style>
      body {
        background: url(./assets/img/concreto.jpg) no-repeat center top fixed;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
      }
      #corpo{
        background-color: #1C1C1C;
      }
      #principal{
        background-color: #242323;
        opacity : 0.7;
      }
      .infor{
        background-color: #4b4a4a;
        border-radius: 20px;
        margin-left: 8px;
        margin-top: 3px;
        padding: 0.4rem;
      }
      .modais{
        background: url(./assets/img/concreto.jpg) no-repeat center top fixed;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
      }
      .modal-title{
        color: rgb(3, 30, 54);
      }
      .modal-body{
        color: aliceblue;
      }
    </style>
  </head>
  <body>
    <div id="header"></div><br /><br /><br />
    <div id="principal" class="container-fluid p-3 mb-2 text-white border border-secondary" style="border-radius: 30px;">
      <div class="row d-flex justify-content-evenly">
        <div class="info col-sm-11 d-flex justify-content-evenly">
          <h1>Aprovação de Gastos</h1>
        </div>
      </div>
      <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#solicitar_gastos">Solicitar Gasto</button>
      <div class="row info justify-content-center" id="info">
        <table class="table table-dark table-striped table-hover">
          <thead>
             <tr>
                <th>#</th>
                <th>Programa</th>
                <th>Projeto</th>
                <th>Item</th>
                <th>Solicitante</th>
                <th>Valor</th>
                <th>Data/Hora Solicitação</th>
                <th>OBS</th>
                <th>Data/Hora Retirada</th>
             </tr>
          </thead>
          <tbody id="corpo_tabela">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Solicitar Gasto -->
    <div class="modal fade" id="solicitar_gastos" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Solicitar Gastos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="input-group mb-3"><span class="input-group-text">Programa:       </span><select   class="form-control" id="programa_insert" onchange ="modal_add_projetos(this.value)"></select></div>
              <div class="input-group mb-3"><span class="input-group-text">Projeto:        </span><select   class="form-control" id="projeto_insert"  onchange ="modal_add_item(this.value)"></select></div>
              <div class="input-group mb-3"><span class="input-group-text">Item:           </span><select   class="form-control" id="item_insert" onchange ="modal_add_solicitante()"></select></div>
              <div class="input-group mb-3"><span class="input-group-text">Solicitante:    </span><input    type="text" class="form-control" disabled id="solicitante_insert"></div>
              <div class="input-group mb-3"><span class="input-group-text">Valor:          </span><input    type="number" class="form-control" id="valor_insert"></div>
              <div class="input-group mb-3"><span class="input-group-text">OBS:            </span><textarea class="form-control" rows="3" id="obs_insert"></textarea></div>
              <div class="input-group mb-3"><span class="input-group-text">Data Retirada:  </span><input    type="date" class="form-control" id="data_retirada"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="btn_inserir" onclick="pedir_gasto()">Cadastrar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="./assets/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/dist/js/geral.js"></script>
    <script>
      var ip = sessionStorage.ip;
      var array_programas = [];
      var array_projetos = [];
      var array_itens = [];
      $("#header").load("menu/menu.html");
      $(document).ready( function($){ verificar(); });

      function modal_add_programas(progs){
        let prog_str = '<option selected disabled>Selecione um Programa</option>';
        progs.map((item, index)=>{
          prog_str += `<option value="${item.id}">${item.nome}</option>`;
        });
        document.getElementById('programa_insert').innerHTML = prog_str;
      }

      function modal_add_projetos(id){
        let str = '<option selected disabled>Selecione um Projeto</option>';
        array_projetos.map((item, index)=>{
          if(item.programa === id && item.aprovado === 'sim'){
            str += `<option value="${item.id}">${item.nome}</option>`;
          }
        });
        document.getElementById('projeto_insert').innerHTML = str;
      }

      function modal_add_item(id){
        let str = '<option selected disabled>Selecione um Item</option>';
        array_itens.map((item, index)=>{
          if(item.id_projeto === id){
            str += `<option value="${item.id}">${item.nome}</option>`;
          }
        });
        document.getElementById('item_insert').innerHTML = str;
      }

      function modal_add_solicitante(){
        document.getElementById('solicitante_insert').value = sessionStorage.nome;
        document.getElementById(`valor_insert`).focus();
      }

      function pedir_gasto(){
        let obj_gasto = {
          id_programa: document.getElementById('programa_insert').value,
          id_projeto: document.getElementById('projeto_insert').value,
          id_item: document.getElementById('item_insert').value,
          solicitante: document.getElementById('solicitante_insert').value,
          valor: parseFloat(document.getElementById("valor_insert").value.replace(",",".")),
          obs: document.getElementById('obs_insert').value,
          data_retirada: document.getElementById('data_retirada').value,
        };
        console.log(obj_gasto);
      }

      async function iniciar(){
        array_programas = await listar_programas();
        array_projetos  = await listar_projetos();
        array_itens     = await listar_itens(); 
      }

      // Modal de Cadastro de projetos.
      var solicitar_gastos = document.getElementById('solicitar_gastos');
      solicitar_gastos.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        modal_add_programas(array_programas);
      });

      iniciar();
    </script>
  </body>
</html>