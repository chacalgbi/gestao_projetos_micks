<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <link rel="shortcut icon" type="image/x-icon" href="./assets/img/icon.png">
    <title>Programas</title>
    <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="./assets/dist/js/jquery-3.6.0.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="./assets/dist/js/sweetalert2.all.min.js"></script>
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script src="./assets/dist/js/pace.js"></script>
    <link rel="stylesheet" href="./assets/dist/css/red/radar.css">
    <script src="./assets/dist/js/notify.js"></script>
    <style>
      body {
        background: url(./assets/img/concreto.jpg) no-repeat center top fixed;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
      }
      #corpo{
        background-color: #1C1C1C;
      }
      #principal{
        background-color: #242323;
        opacity : 0.7;
      }
      .infor{
        background-color: #4b4a4a;
        border-radius: 20px;
        margin-left: 8px;
        margin-top: 3px;
        padding: 0.4rem;
      }
      .modais{
        background: url(./assets/img/concreto.jpg) no-repeat center top fixed;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
      }
      .modal-title{
        color: aliceblue;
      }
      .modal-body{
        color: aliceblue;
      }
    </style>
  </head>
  <body>
    <div id="header"></div><br /><br /><br />
    <div id="principal" class="container p-3 mb-2 text-white border border-secondary" style="border-radius: 30px;">
      <div class="row d-flex justify-content-evenly">
        <div class="info col-sm-11 d-flex justify-content-evenly">
          <h1>Projetos</h1>
        </div>
      </div>
      <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modal_inserir">Inserir Projeto</button>
      <div class="row info justify-content-center" id="info">
        <table class="table table-dark table-hover">
          <thead>
             <tr>
               <th>#</th>
               <th>Projeto</th>
               <th>Programa</th>
               <th>Envolvidos</th>
               <th>Objetivo</th>
               <th>Prev. Início</th>
               <th>Prev. Fim</th>
               <th>Concluído</th>
               <th>OBS</th>
               <th>Status</th>
               <th>Editar</th>
             </tr>
           </thead>
           <tbody id="corpo_tabela">
           </tbody>
         </table>
      </div>
    </div>

    <!-- Editar -->
    <div class="modal fade" id="modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content modais">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Editar Programa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div>ID:<label id="id_"></label></div>
              <div>Nome:<input type="text" class="form-control" id="nome"></div>
              <div>Programa:<select class="form-control" id="programa"></select></div>
              <div>Envolvidos:<div id="checks"></div></div>
              <div>Objetivos:<textarea class="form-control" rows="4" id="objetivos"></textarea></div>
              <div>OBS:      <textarea class="form-control" rows="4" id="obs"></textarea></div>
              <div>Previsão de Início:<input type="date" class="form-control" id="prev_inicio"></div>
              <div>Previsão de Fim:<input type="date" class="form-control" id="prev_fim"></div>
              <div>Concluido?<select class="form-control" id="concluido"></select></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="btn_editar" onclick="salvar()">Alterar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Inserir -->
    <div class="modal fade" id="modal_inserir" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content modais">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Inserir Programa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body modais">
            <form>
              <div class="mb-3">
                <label class="col-form-label">Nome:</label>
                <input type="text" class="form-control" id="nome_insert">
              </div>
              <div class="mb-3">
                <labelclass="col-form-label">OBS:</label>
                <textarea class="form-control" rows="6" id="obs_insert"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="btn_inserir" onclick="inserir()">Cadastrar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="./assets/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/dist/js/geral.js"></script>

    <script>
      var ip = sessionStorage.ip;
      var array_programas = [];

      $("#header").load("menu/menu.html");
      $(document).ready( function ($){
        verificar();
      });

      async function listar_programas(){
        await axios.get(`${ip}programa_read`).then(function (response) {
                if(response.data.erroGeral === 'sim'){
                  sessionStorage.login = 'NOT';
                  Swal.fire({ icon: 'error', title: 'Oops...', text: 'Erro interno, procure o ADMIN' });
                  return array_programas;
                }else{
                  //console.log(response.data.dados.resposta);
                  response.data.dados.resposta.map((item, index, array)=>{
                    let obj = {};
                    obj.id = item.id;
                    obj.nome = item.nome;
                    array_programas.push(obj);
                  });
                  return array_programas;
                }
                
            })
            .catch(function (error) {
              console.log(error);
              return array_programas;
            });
      }

      function iniciar(){
        let tabela_ = document.getElementById('corpo_tabela');

        axios.get(`${ip}projetos_read`).then(function (response) {
                if(response.data.erroGeral === 'sim'){
                  sessionStorage.login = 'NOT';
                  Swal.fire({ icon: 'error', title: 'Oops...', text: 'Erro interno, procure o ADMIN' });
                }else{
                  //console.log(response.data.dados.resposta);
                  $.notify(`Projetos Cadastrados: ${response.data.dados.resposta.length}`, "success");
                  let tabela = "";
                  response.data.dados.resposta.map((item, index, array)=>{
                    let imagem = '';
                    if(item.aprovado === 'nao'){
                      imagem = 'loading.gif';
                    }else if(item.aprovado === 'sim'){
                      imagem = 'OK.png';
                    }else{
                      imagem = 'bloqueado.png';
                    }
                    tabela += "<tr>";
                      tabela += `
                      <td>${index+1}</td>
                      <td>${item.nome}</td>
                      <td>${item.prog}</td>
                      <td>${item.responsaveis}</td>
                      <td>${item.objetivo}</td>
                      <td>${item.inicio}</td>
                      <td>${item.fim}</td>
                      <td>${item.concluido}</td>
                      <td>${item.obs}</td>
                      <td><img src="./assets/img/${imagem}" width="40" height="40"></td>
                      <td><button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modal"
                        data-bs-id="${item.id}"
                        data-bs-nome="${item.nome}"
                        data-bs-prog="${item.programa}"
                        data-bs-responsaveis="${item.responsaveis}"
                        data-bs-objetivo="${item.objetivo}"
                        data-bs-inicio="${item.previsao_inicio}"
                        data-bs-fim="${item.previsao_fim}"
                        data-bs-concluido="${item.concluido}"
                        data-bs-obs="${item.obs}"
                      >Editar</button></td>
                      `;
                    tabela += "</tr>";
                  });
                  tabela_.innerHTML = tabela;
                }
                
            })
            .catch(function (error) { console.log(error) });
      }

      function salvar(){
        const id = document.getElementById('id_').innerHTML;
        const nome = document.getElementById('nome').value;
        const obs = document.getElementById('obs').value;
        if(id === '' || nome === ''){
          Swal.fire({ icon: 'info', title: 'Oops...', text: 'Preencha o campo nome do programa!' });
        }else{
          axios.post(`${ip}programa_update`,{nome, obs, id}).then(function (response) {
              if(response.data.erroGeral === 'sim'){
                Swal.fire({ icon: 'error', title: 'Oops...', text: 'Erro interno, procure o ADMIN' });
              }else{
                //console.log(response.data.dados.resposta);
                $("#btn_editar").notify( "Programa atualizado com sucesso!", { position:'botton right', className:'success', autoHideDelay:2000 });
                setTimeout(function() { location.replace("programas.html"); }, 2000);
              }
          })
          .catch(function (error) { console.log(error) });
        }
      }

      function inserir(){
        const nome = document.getElementById('nome_insert').value;
        const obs = document.getElementById('obs_insert').value;
        if(nome === ''){
          Swal.fire({ icon: 'info', title: 'Oops...', text: 'Preencha o campo nome do programa!' });
        }else{
          axios.post(`${ip}programa_insert`,{nome, obs}).then(function (response) {
            if(response.data.erroGeral === 'sim'){
              Swal.fire({ icon: 'error', title: 'Oops...', text: 'Erro interno, procure o ADMIN' });
            }else{
              //console.log(response.data.dados.resposta);
              //$.notify(`Programa Inserido`, "success");
              $("#btn_inserir").notify( "Programa cadastrado com sucesso!", { position:'botton right', className:'success', autoHideDelay:2000 });
              setTimeout(function() { location.replace("programas.html"); }, 2000);
            }
          })
          .catch(function (error) { console.log(error) });
        }
      }

      function deletar(id){
        Swal.fire({
          title: 'Deseja apagar este programa? Os projetos relacionados a ele serão afetados! (AÇÃO NÃO RECOMENDADA!)',
          icon: 'question',
          showDenyButton: true,
          showCancelButton: false,
          confirmButtonText: 'Apagar',
          denyButtonText: `Cancelar operação`,
        }).then((result) => {
          if (result.isConfirmed) {
              axios.post(`${ip}programa_delete`,{id: id}).then(function (response) {
                  if(response.data.erroGeral === 'sim'){
                    Swal.fire({ icon: 'error', title: 'Oops...', text: 'Erro interno, procure o ADMIN' });
                  }else{
                    Swal.fire('Programa deletado!', 'Verifique se os projetos não foram afetados.', 'success');
                    setTimeout(function() { location.replace("programas.html"); }, 2000);
                  }
              })
              .catch(function (error) { console.log(error) });
          } else if (result.isDenied) {
            Swal.fire('Operação cancelada!', '', 'info');
          }
        });
      }

      iniciar();
      listar_programas();

      var cx_modal = document.getElementById('modal');
      cx_modal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        document.getElementById('nome').value = button.getAttribute('data-bs-nome');
        document.getElementById('objetivos').value = button.getAttribute('data-bs-objetivo');
        document.getElementById('obs').value = button.getAttribute('data-bs-obs');

        const inicio1 = button.getAttribute('data-bs-inicio').split("T");
        document.getElementById('prev_inicio').value = inicio1[0];

        const fim1 = button.getAttribute('data-bs-fim').split("T");
        document.getElementById('prev_fim').value = fim1[0];

        let selec_concluido = '';
        if(button.getAttribute('data-bs-concluido')==='sim'){
          selec_concluido = `<option value="sim" selected>Sim</option><option value="nao">Não</option>`;
        }else{
          selec_concluido = `<option value="sim">Sim</option><option value="nao" selected>Não</option>`;
        }
        document.getElementById('concluido').innerHTML = selec_concluido;

        let prog_id = button.getAttribute('data-bs-prog');
        let prog_str = '';
        array_programas.map((prog)=>{
          if(prog_id == prog.id){
            prog_str += `<option value="${prog.id}" selected>${prog.nome}</option>`;
          }else{
            prog_str += `<option value="${prog.id}">${prog.nome}</option>`;
          }
        });
        document.getElementById('programa').innerHTML = prog_str;

        listar_perfis();
        
      });
    </script>
  </body>
</html>
